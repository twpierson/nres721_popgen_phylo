---
title: "Basic population genomic and phylogenomic analyses"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Todd W. Pierson"
date: "23 October 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this tutorial, we'll conduct some simple population genomic and phylogenomic analyses using the *Urspelerpes* data we assembled in the last tutorial. 

Load the packages you need.
```{r, echo = TRUE, results = "hide", warning = FALSE, message = FALSE}
library(phangorn)
library(adegenet)
```

Read in one of the output files from the `ipyrad` assembly.
```{r}
ubrucei_phydat <- read.phyDat("data/ubrucei.u.snps.phy", format="phy", type="DNA")
```

Create a distance matrix.
```{r}
dm.dat <- dist.ml(ubrucei_phydat, exclude='pairwise')
```

Create a neighbor-joining tree for a quick peek at the data.
```{r}
treeNJ.dat <- NJ(dm.dat)
```

```{r}
# plot tree as unrooted
plot.phylo(treeNJ.dat, cex=0.9, type='u',
     tip.col = c(rep("green",3), rep("red",3), rep("cornflowerblue",3)),
     font = 2, x.lim = c(-0.1, 0.4))
```

Let's try a discriminant analysis of principle components (DAPC). For a much more detailed description of these analyses and a tutorial of how to conduct them, see [here](http://adegenet.r-forge.r-project.org/files/tutorial-dapc.pdf).

We'll read in another output file from `ipyrad`. 
```{r, results = "hide", warning = FALSE, message = FALSE}
ubrucei_strdat <- read.structure(file="data/ubrucei.str",
                         n.ind = 9, n.loc = 889,
                         onerowperind = FALSE, col.lab=1,
                         col.pop=0, NA.char="-9",col.other=0,
                         row.marknames=0)
```

Let's determine the number of clusters.
```{r}
ubrucei_clust <- find.clusters(ubrucei_strdat, n.pca = 20, max.n.clust = 5, n.clust = 3)
```

Do the DAPC. 
```{r}
ubrucei_dapc <- dapc(ubrucei_strdat, ubrucei_clust$grp, n.pca = 20, n.da = 2)
```

Plot results in a Structure-like barplot.
```{r}
par(xpd = TRUE)
compoplot(ubrucei_dapc, xlab="individuals", 
          col = c("red","cornflowerblue","green"), legend = FALSE, show.lab = TRUE)
legend(1, 1.1, legend=paste("Cluster", 1:3), fill=c("red","cornflowerblue","green"), ncol = 3, cex = 0.7)
```

